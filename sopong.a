	processor 6502
        include "vcs.h"
        include "macro.h"
        include "xmacro.h"

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Variables segment

        seg.u Variables
	org $80

ballX		.byte
ballY		.byte
ballDx		.byte
ballDy		.byte
p1y		.byte
p2y		.byte
sball		.byte
sp1		.byte
sp2		.byte
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Code segment

	seg Code
        org $f000

Start
	CLEAN_START
	lda #$0a
	sta COLUPF
        sta COLUP0
        sta COLUP1
        lda #%00100001
        sta CTRLPF
        lda #%00100000
        sta NUSIZ0
        sta NUSIZ1
        lda #90
        sta ballX
        sta ballY
	sta p1y
        sta p2y
	lda #1
        sta ballDx
        lda #-1
        sta ballDy

NextFrame
        lsr SWCHB	; test Game Reset switch
        bcc Start	; reset?
; 1 + 3 lines of VSYNC
	VERTICAL_SYNC
; 37 lines of underscan
	TIMER_SETUP 37
        lda #$ff
        sta PF2
        sta PF1
        sta PF0
    	
        lda ballX	; get X coordinate
        ldx #4		; player 0
        jsr SetHorizPos	; set coarse offset
        
        lda #20
        ldx #2		; player 0
        jsr SetHorizPos	; set coarse offset

        lda #168
        ldx #3		; player 0
        jsr SetHorizPos	; set coarse offset


	sta WSYNC	; sync w/ scanline
        sta HMOVE	; apply fine offsets 
        
        TIMER_WAIT
        	
        ldx #0
	stx VBLANK

	SKIP_SCANLINES 7
        
        stx PF0
        stx PF1
        stx PF2
        

        ; 192 lines of frame
	ldx #176	; X = 192 scanlines
LVScan
	ldy #1
        sty sball
        sty sp1
        sty sp2
        iny
        
	txa
        sec		; set carry for subtract
        sbc ballY	; local coordinate
        cmp #8          ; in sprite?
        bcs InSprite	; yes, skip over next
        sty sball	; not in sprite, load 0
InSprite
    	
	;txa		; X -> A
        ;sec		; set carry for subtract
        ;sbc p2y	; local coordinate
        ;cmp #32         ; in sprite?
        ;bcs InPl2	; yes, skip over next
        ;sty sp2	; not in sprite, load 0
InPl2

	txa		; X -> A
        sec		; set carry for subtract
        sbc p1y		; local coordinate
        cmp #32         ; in sprite?
        bcs InPl1	; yes, skip over next
        sty sp1		; not in sprite, load 0
InPl1
 	lda sball
        ldy sp1
 	sta WSYNC

        sta ENABL
        sty ENAM0
;        sta ENAM1

	txa
        and #4
        beq l2
        lda #128
l2        
	sta PF2               
	  
pfskip
        
        dex		; decrement X
        bne LVScan	; repeat until 192 lines
	sta WSYNC
        
	lda #$ff
        sta PF0
        sta PF1
        sta PF2

	SKIP_SCANLINES 7


; 29 lines of overscan
        lda #2
        sta VBLANK
	TIMER_SETUP 29

	lda ballX
        clc 
        adc ballDx
        sta ballX
        cmp #16
        beq bounceBallX
        cmp #172
        beq bounceBallX
        bne skipBounceX
bounceBallX        
        lda ballDx
        eor #$ff
        clc
        adc #1
        sta ballDx

skipBounceX

	lda ballY
        clc 
        adc ballDy
        sta ballY
        cmp #3
        beq bounceBallY
        cmp #170
        beq bounceBallY
        bne skipBounce
bounceBallY        
        lda ballDy
        eor #$ff
        clc
        adc #1
        sta ballDy

        
skipBounce        
        TIMER_WAIT
; total = 262 lines, go to next frame
        jmp NextFrame


; SetHorizPos routine
; A = X coordinate
; X = player number (0 or 1)
SetHorizPos
	sta WSYNC	; start a new line
	sec		; set carry flag
DivideLoop
	sbc #15		; subtract 15
	bcs DivideLoop	; branch until negative
	eor #7		; calculate fine offset
	asl
	asl
	asl
	sta RESP0,x	; fix coarse position
	asl
	sta HMP0,x	; set fine offset
	rts		; return to caller

        

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Epilogue

	org $fffc
        .word Start	; reset vector
        .word Start	; BRK vector
